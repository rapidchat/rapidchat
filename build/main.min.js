angular.module("rapidchat",["btford.socket-io","ngStorage","ngSanitize"]).run(["$localStorage","$rootScope","User","$log",function(){var e=!1,s="./bower_components/openpgp/dist/";s+=e?"openpgp.worker.js":"openpgp.worker.min.js",openpgp.initWorker(s)}]).config(["$logProvider",function(e){e.debugEnabled(!1)}]).factory("db",function e(){var e=new Dexie("Rapidchat");return e.version(1).stores({users:"++id,uid,userId,keyId",messages:"++id,from,message,time,channel"}),e.open(),e.on("blocked",function(){console.error("Db blocked!")}),e}).factory("Socket",["socketFactory","$window",function(e,s){var n=io.connect(s.location.pathname.substr(1));return e({prefix:"",ioSocket:n})}]),angular.module("rapidchat").factory("Channel",["$localStorage","Socket","Message","db","$timeout","$log",function(e,s,n,t,r,i){function o(e,s){return this.channel=null,this.user=e,this.users=[],this.messages=[],this.$scope=s,this}return o.prototype.join=function(n){var t=this;return this.channel=n,e.channel=n,this.loadMessages().then(function(){s.emit("join",{channel:n,uid:t.user.uid,publicKey:t.user.publicKey.armor()})}),this},o.prototype.loadMessages=function(){var e=this;return this.messages=[],t.messages.where("channel").equals(this.channel).each(function(s){s&&e.addMessage(s)}).then(function(){return Promise.resolve()}).catch(function(e){return i.error("Error while loading messages",e),Promise.reject(e)})},o.prototype.scrollToBottom=function(){var e=document.getElementById("messages-container");e.scrollTop=e.scrollHeight},o.prototype.clearMessages=function(){var e=this;t.messages.where("channel").equals(this.channel).delete().then(function(){e.messages=[],e.reset()}).catch(function(){i.error("Error while deleting messages")})},o.prototype.reset=function(){var e=this;r(function(){"$apply"!=e.$scope.$root.$$phase&&"$digest"!=e.$scope.$root.$$phase&&e.$scope.$apply(),e.scrollToBottom()})},o.prototype.addMessage=function(e){return this.messages.push({from:e.from,time:e.time,message:e.message}),this.reset(),this},o.prototype.current=function(){return this.channel},o.prototype.people=function(e){return this.users=e,this},o.prototype.online=function(){return this.users},o}]),angular.module("rapidchat").service("Keyring",["$log",function s(e){var s=new openpgp.Keyring;return s.addPublicKey=function(s){var n=s.primaryKey.getKeyId().toHex(),t=this.getKeysForId(n);t?e.debug("Key was in the ring"):(this.publicKeys.push(s),this.store())},s}]),angular.module("rapidchat").controller("MainCtrl",["$scope","User","Socket","$localStorage","$log","Keyring","Message","Channel","$rootScope",function(e,s,n,t,r,i,o,a){var c=document.getElementById("textbox");e.messages=[],e.channel={},t.userId&&s.login(t.userId).then(function(s){e.user=s,e.channel=new a(s,e),r.debug("User logged in",e.user),t.channel&&e.channel.join(t.channel)}),e.theme=t.theme?t.theme:"tomorrow",e.white=t.white?t.white:!1,e.oldTheme=e.theme,e.changeTheme=function(){var s=document.getElementById("theme-"+e.theme),n=document.getElementById("theme-"+e.oldTheme);n&&(n.disabled=!0),s&&(s.disabled=!1),e.oldTheme=e.theme,t.theme=e.theme};var l=document.getElementById("theme-"+e.theme);l&&(l.disabled=!1),e.blackOrWhite=function(){var s=[{white:"base07-background",black:"base00-background"},{white:"base02",black:"base05"}],n=1==e.white?"white":"black",r=1==e.white?"black":"white",i=document.getElementsByTagName("body")[0];for(var o in s)i.classList.add(s[o][n]),i.classList.remove(s[o][r]);t.white=e.white},e.blackOrWhite(),e.login=function(n){s.login(n.userId).then(function(s){e.user=s,e.channel=new a(s,e)})},e.join=function(s){if(!e.user)throw new Error("User does not exist");e.channel.join(s)},n.on("joined",function(s){e.channel.people(s)}),n.on("left",function(s){e.channel.people(s.users)}),c.onkeypress=function(s){13!=s.keyCode||s.shiftKey||e.message(s.currentTarget.value)},e.message=function(s){if(s&&s.length){var n=new o(s,e.channel);n&&n.encode()}},n.on("message",function(s,n,t){var r=new o(n,e.channel,t,s);r.decode()}),n.on("exchange ping",function(s,t){var r=openpgp.key.readArmored(t).keys[0];i.addPublicKey(r),n.emit("exchange pong",s,e.user.publicKey.armor())}),n.on("exchange pong",function(e){var s=openpgp.key.readArmored(e).keys[0];i.addPublicKey(s)}),e.userClick=function(e){c&&(c.value=c.value+e)},e.logout=function(){delete t.userId}}]).directive("userlist",function(){return{restrict:"E",scope:{users:"="},templateUrl:"html/user-list.html",link:function(e){e.userClick=e.$parent.userClick}}}).filter("prettyUser",["$sce",function(e){return function(s,n){var t=s.split("-"),r="base0B";return s==n&&(r="base0E"),e.trustAsHtml('<span class="'+r+'" ng-click="userClick('+s+')">'+t[0]+": </span>")}}]),angular.module("rapidchat").factory("Message",["$log","Socket","Keyring","db","Smileys",function(e,s,n,t,r){function i(e,s,n,t){this.commands=["msg","roll"],this.channel=s,this.time=n||Date.now();var r=this.preprocessor(e,t);return r instanceof Error?(this.print(r),!1):this}return i.prototype.preprocessor=function(e,s){if(s)return this.message=e,this.from=s,this;if("/"==e.substr(0,1)){e=e.split(" ");var n=e.splice(0,2);if(this.argument=n[1],this.command=n[0].substr(1),this.message=e.join(" "),-1===this.commands.indexOf(this.command))return new Error(this.command+" is not a command")}else this.message=e;return this.from=this.channel.user.uid,this},i.prototype.encode=function(){var t=this,r=null;if("msg"==this.command){if(r=this.channel.users[this.argument],!r)return this.print(new Error("User "+this.argument+" does not exist")),!1;this.message="(*Whispers to "+this.argument+"*) "+this.message}else if("roll"==this.command){var i;if("hack"==this.argument)i=6;else{var o=6,a=1;i=Math.floor(Math.random()*(o-a+1)+a)}this.message="(*Roll 1d6*) "+i}return openpgp.encryptMessage(n.publicKeys.keys,this.message).then(function(n){s.emit("message",t.channel.user.userId,n,t.time,r),e.debug("emitted msg: "+t.message),t.print(),t.save()}).catch(function(){e.error("Error while encoding message",err)}),this},i.prototype.decode=function(){var s=this,t=n.privateKeys.getForId(this.channel.user.keyId),r=openpgp.message.readArmored(this.message);openpgp.decryptMessage(t,r).then(function(n){s.message=n,s.print(),s.save(),e.debug("received msg: "+n)}).catch(function(){e.error("Error while decoding message",err)})},i.prototype.save=function(){t.messages.add({from:this.from,message:this.message,time:this.time,channel:this.channel.current()}).then(function(){}).catch(function(){e.error("Error while saving message",err)})},i.prototype.format=function(e){e=marked(e),e instanceof Error&&(e="<span class='base08'>"+e.message+"</span>");for(var s in r)e=e.replace(s,'<img src="'+r[s]+'">');return e},i.prototype.print=function(e){e||(e=this.message),this.message=this.format(e),this.channel.addMessage(this);var s=document.getElementById("textbox");return s.value="",this},i}]),angular.module("rapidchat").factory("Smileys",function(){var e={":)":"smileys/smile.png","=)":"smileys/smile.png",":|":"smileys/neutral.png","=|":"smileys/neutral.png",":(":"smileys/sad.png","=(":"smileys/sad.png",":D":"smileys/big_smile.png","=D":"smileys/big_smile.png",":O":"smileys/yikes.png",";)":"smileys/wink.png",":-/":"smileys/hmm.png",":P":"smileys/tongue.png",":p":"smileys/tongue.png",":lol:":"smileys/lol.png",":mad:":"smileys/mad.png",":rolleyes:":"smileys/roll.png",":cool:":"smileys/cool.png",":noel:":"smileys/noel.gif",":fuck:":"smileys/fuck.png",":siffle:":"smileys/siffle.gif",":cry:":"smileys/pleure.gif",":blink:":"smileys/blink.gif",":unsure:":"smileys/unsure.gif",":ange:":"smileys/ange.gif",":mdr:":"smileys/mdr.gif",":bisous:":"smileys/bisous.gif",":taper:":"smileys/taper.gif",":canon:":"smileys/canon.gif",":fouet:":"smileys/fouet.gif",":huh:":"smileys/huh.gif",":mrgreen:":"smileys/mrgreen.gif",":oui:":"smileys/oui.gif",":non:":"smileys/non.gif",":ok:":"smileys/ok.gif",":reflechi:":"smileys/reflechi.gif",":demon:":"smileys/demon.gif",":hap:":"smileys/hap.gif"};return e}),angular.module("rapidchat").factory("User",["db","Keyring","$localStorage","$q","$log",function(e,s,n,t,r){function i(e){if(!e.keys)throw new TypeError("Keys are required");for(var s in e.keys)e.keys[s].isPublic()&&(e.publicKey=e.keys[s]);return e}var o={create:function(o){var a=t.defer();return openpgp.generateKeyPair({numBits:1024,userId:o,passphrase:""}).catch(function(e){r.error("Error while generating key pair",e),a.reject(e)}).then(function(n){var t=n.key.primaryKey.getKeyId().toHex();s.privateKeys.push(n.key),s.publicKeys.push(n.key.toPublic()),s.store();var r={userId:o,keyId:t,uid:o+"-"+t,keys:n};return e.users.add(r)}).catch(function(e){r.error("Error while creating user",e),a.reject(e)}).then(function(e){i(e),n.userId=o,a.resolve(e)})},login:function(o){var a=t.defer(),c=this;return e.users.where("userId").equals(o).first().then(function(e){if(e){var t=s.getKeysForId(e.keyId);e.keys=t,i(e),n.userId||(n.userId=o),a.resolve(e)}else c.create(o).then(a.resolve)}).catch(function(e){r.error("Error while getting user for userId",o,e),a.reject(e)}),a.promise},logout:function(){}};return o}]);